<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostChat - Ultra Private</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .smooth { transition: all 0.3s ease-in-out; }
        .mode-bright { background-color: #f1f5f9; color: #0f172a; }
        .card-bright { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .mode-dark { background-color: #0f172a !important; color: #f1f5f9 !important; }
        .card-dark { background-color: #1e293b !important; border: 1px solid #334155 !important; }
        .chat-bubble-me { background: #2563eb; color: white; border-radius: 18px 18px 0 18px; }
        .chat-bubble-them { background: #475569; color: white; border-radius: 18px 18px 18px 0; }
        #messageBox::-webkit-scrollbar { width: 4px; }
        #messageBox::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body id="mainBody" class="mode-bright smooth min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <div class="fixed top-5 right-5 z-50">
        <button onclick="toggleTheme()" id="themeBtn" class="p-3 rounded-2xl bg-white shadow-lg border border-slate-200 flex items-center gap-2 smooth text-slate-800">
            <span id="themeIcon">ðŸŒ™</span>
            <span id="themeText" class="text-xs font-bold uppercase tracking-wider">Dark</span>
        </button>
    </div>

    <div id="setupCard" class="card-bright p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md smooth">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black tracking-tighter text-blue-600">GHOST<span class="text-slate-400">CHAT</span></h1>
            <p class="text-xs font-medium opacity-50 mt-1 uppercase tracking-widest">No Database â€¢ No Logs â€¢ RAM Only</p>
        </div>

        <div class="space-y-5">
            <div>
                <label class="text-[10px] font-black uppercase opacity-60 ml-2">Room Alfabet (A-Z)</label>
                <input type="text" id="roomLetter" maxlength="1" placeholder="A" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 text-center text-2xl font-bold focus:border-blue-500 outline-none smooth">
            </div>
            <div>
                <label class="text-[10px] font-black uppercase opacity-60 ml-2">Room Angka (1550-1990)</label>
                <input type="number" id="roomNumber" min="1550" max="1990" placeholder="1550" class="w-full p-4 mt-1 rounded-2xl border-2 border-slate-100 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 text-center text-2xl font-bold focus:border-blue-500 outline-none smooth">
            </div>
            <button onclick="initP2P()" id="btnJoin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 dark:shadow-none transition-all active:scale-95 uppercase tracking-wider">
                Mulai Chatting
            </button>
        </div>
    </div>

    <div id="chatInterface" class="hidden w-full max-w-lg h-[90vh] card-bright rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden smooth">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
            <div>
                <p class="text-[10px] uppercase font-bold opacity-70">Privat Room</p>
                <h2 id="activeRoomName" class="font-black text-xl tracking-tight">A-1550</h2>
            </div>
            <button onclick="location.reload()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-xs font-bold backdrop-blur-md transition">Keluar</button>
        </div>
        
        <div id="messageBox" class="flex-1 p-6 overflow-y-auto space-y-4 flex flex-col bg-transparent">
            <div class="self-center bg-slate-100 dark:bg-slate-800 px-4 py-1 rounded-full text-[10px] text-slate-500 font-bold uppercase tracking-widest">Menunggu teman...</div>
        </div>

        <div class="p-4 bg-slate-50/50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-800 flex gap-2">
            <input type="text" id="messageInput" placeholder="Ketik pesan rahasia..." class="flex-1 p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-inner outline-none focus:ring-2 focus:ring-blue-500 smooth">
            <button onclick="sendPrivateMessage()" class="bg-blue-600 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14M12 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        let peer = null;
        let conn = null;
        let isDark = false;

        // FUNGSI TEMA (FIXED)
        function toggleTheme() {
            const body = document.getElementById('mainBody');
            const setupCard = document.getElementById('setupCard');
            const chatInterface = document.getElementById('chatInterface');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            const themeBtn = document.getElementById('themeBtn');

            isDark = !isDark;
            if (isDark) {
                body.className = "mode-dark smooth min-h-screen flex flex-col items-center justify-center p-4 font-sans";
                setupCard.className = "card-dark p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md smooth";
                chatInterface.classList.add('card-dark');
                themeIcon.innerText = "â˜€ï¸";
                themeText.innerText = "Bright";
                themeBtn.classList.replace('bg-white', 'bg-slate-800');
                themeBtn.classList.add('text-white');
            } else {
                body.className = "mode-bright smooth min-h-screen flex flex-col items-center justify-center p-4 font-sans";
                setupCard.className = "card-bright p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md smooth";
                chatInterface.classList.remove('card-dark');
                themeIcon.innerText = "ðŸŒ™";
                themeText.innerText = "Dark";
                themeBtn.classList.replace('bg-slate-800', 'bg-white');
                themeBtn.classList.remove('text-white');
            }
        }

        // FUNGSI LOGIKA CHAT (RE-CONNECTED)
        function initP2P() {
            const letter = document.getElementById('roomLetter').value.toUpperCase();
            const number = document.getElementById('roomNumber').value;

            if (!letter || !number) return alert("Pilih room dulu!");

            const roomID = `ghost-room-${letter}-${number}`;
            document.getElementById('btnJoin').innerText = "Membuka Jalur...";

            peer = new Peer(roomID);

            peer.on('open', (id) => {
                showChat(letter, number);
            });

            // Jika ada orang lain yang join ke room yang sama
            peer.on('connection', (c) => {
                conn = c;
                setupChatEvents();
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // Jika ID (room) sudah ada, kita yang join ke dia
                    conn = peer.connect(roomID);
                    setupChatEvents();
                    showChat(letter, number);
                } else {
                    alert("Koneksi gagal: " + err.type);
                    location.reload();
                }
            });
        }

        function setupChatEvents() {
            conn.on('data', (data) => {
                appendMessage(data, 'them');
            });
            conn.on('open', () => {
                appendMessage("Terhubung secara privat.", "system");
            });
        }

        function showChat(l, n) {
            document.getElementById('setupCard').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            document.getElementById('activeRoomName').innerText = `${l}-${n}`;
        }

        function sendPrivateMessage() {
            const input = document.getElementById('messageInput');
            if (conn && conn.open) {
                const msg = input.value;
                if (!msg) return;
                conn.send(msg);
                appendMessage(msg, 'me');
                input.value = "";
            } else {
                alert("Belum ada teman di room ini atau koneksi putus.");
            }
        }

        function appendMessage(text, type) {
            const box = document.getElementById('messageBox');
            const msgDiv = document.createElement('div');
            
            if (type === 'me') {
                msgDiv.className = "self-end chat-bubble-me p-4 max-w-[85%] shadow-md text-sm font-medium";
            } else if (type === 'them') {
                msgDiv.className = "self-start chat-bubble-them p-4 max-w-[85%] shadow-md text-sm font-medium";
            } else {
                msgDiv.className = "self-center text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] py-2";
            }

            msgDiv.innerText = text;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
        }

        // Support Enter Key
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendPrivateMessage();
        });
    </script>
</body>
</html>
